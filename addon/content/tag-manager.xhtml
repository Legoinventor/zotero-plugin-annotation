<!DOCTYPE html>
<html>

<head>
  <title>Kapitel-Tag Manager</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }

    .note {
      margin-bottom: 1em;
      padding: 0.5em;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <h1>Kapitel-Tags zuweisen</h1>
  <div id="notes-container">Loading notes...</div>
  <button id="save-btn">Speichern</button>

  <script type="module">
    const { Zotero, Services } = window;
    const notesContainer = document.getElementById("notes-container");

    const win = window.arguments[0];
    const collectionID = win.collectionID;

    const notes = Zotero.Items.getItems()
      .filter(item => item.isNote() && item.getCollections().includes(collectionID));

    notesContainer.innerHTML = "";

    notes.forEach(note => {
      const div = document.createElement("div");
      div.className = "note";

      const textarea = document.createElement("textarea");
      textarea.rows = 5;
      textarea.cols = 50;
      textarea.value = note.getNote();
      textarea.disabled = true;

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Kapitel-Tag eingeben";

      div.appendChild(textarea);
      div.appendChild(document.createElement("br"));
      div.appendChild(input);
      notesContainer.appendChild(div);

      div.dataset.noteId = note.id;
    });

    document.getElementById("save-btn").addEventListener("click", async () => {
      const divs = notesContainer.querySelectorAll(".note");
      for (const div of divs) {
        const tag = div.querySelector("input").value;
        if (tag) {
          const note = Zotero.Items.get(parseInt(div.dataset.noteId));
          note.addTag({ tag });
          await note.saveTx();
        }
      }
      window.close();
    });
  </script>
</body>

</html>